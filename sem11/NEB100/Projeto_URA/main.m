close all;
clear;
clc;
clear global; #Limpa variavel global

function aperta(ObjH, eventdata, tecla, txt_frm, g11, g12, g21, g22)

  #disp(tecla)

  % Call DTMF
  fs = 8000; # Frequencia de amostragem [Hz]
  sinal_out = dtmf_gen(tecla, fs);

  % Adiciona ruido
  sinal_in = sinal_out + 0.5 * randn(size(sinal_out));
  #sinal_in = sinal_in/max(abs(sinal_in)); #Normalizando o sinal

  % Grava audio
  #audiowrite('sinal.wav', sinal, fs);

  % Toca audio
  playblocking(audioplayer(sinal_out, fs, 24));

  % Transformada de Fourrier para o sinal (Verificação)
  #figure([], 'name', 'FFT', 'numbertitle', 'off');
  #stem(1:(8000/length(sinal)):8000, abs(fft(sinal)), '.');

  %% Inserindo dados nos gráficos
  l = length(sinal_out);
  x = 0:1/8000:l/fs;
  x(end) = [];

  % Gráficos de saida
  set(g11, 'xdata', x);
  set(g11, 'ydata', sinal_out);
  set(g12, 'xdata', 1:(fs/length(sinal_out)):fs);
  set(g12, 'ydata', abs(fft(sinal_out)));

  % Gráficos de entrada
  set(g21, 'xdata', x);
  set(g21, 'ydata', sinal_in);
  set(g22, 'xdata', 1:(fs/length(sinal_in)):fs);
  set(g22, 'ydata', abs(fft(sinal_in)));

  % Call servico
  #texto = char([get(txt_frm, 'string'), 10, servico(sinal, fs)]);
  set(txt_frm, 'string', servico(sinal_in, fs));
endfunction

% GUI janela
MainFrm = figure(1, 'name', 'DTMF', 'numbertitle', 'off');

% Container de texto
texto = uipanel(MainFrm, ...
  'units', 'normalized', ...
  'position', [0.3, 0, 0.7, 0.5]);

txt_frm = uicontrol(texto, ...
  'style', 'text', ...
  'string', '', ...
  'verticalalignment', 'top', ...
  'horizontalalignment', 'left', ...
  'units', 'normalized', ...
  'position', [0, 0, 1, 1], ...
  'backgroundcolor', [1 1 1]);

% Conteiner plot 1
grafico1 = uipanel(MainFrm, ...
  'title', 'Sinal saída', ...
  'units', 'normalized', ...
  'position', [0, 0.5, 0.5, 0.5]);

#Setando Grafico 11
subplot(2, 1, 1, 'parent', grafico1);
g11 = plot([1], 'marker', 'none');
title('Sinal');
xlabel('Tempo [s]');
grid on;
grid minor on;

#Setando Grafico 12
subplot(2, 1, 2, 'parent', grafico1);
g12 = plot([1], 'marker', 'none');
title('Sinal (FFT)');
xlabel('Frequencia [Hz]');
grid on;
grid minor on;

% Conteiner plot 2
grafico2 = uipanel(MainFrm, ...
  'title', 'Sinal entrada', ...
  'units', 'normalized', ...
  'position', [0.5, 0.5, 0.5, 0.5]);

#Setando Grafico 21
subplot(2, 1, 1, 'parent', grafico2);
g21 = plot([1], 'marker', 'none');
title('Sinal');
xlabel('Tempo [s]');
grid on;
grid minor on;

#Setando Grafico 22
subplot(2, 1, 2, 'parent', grafico2);
g22 = plot([1], 'marker', 'none');
title('Sinal (FFT)');
xlabel('Frequencia [Hz]');
grid on;
grid minor on;

% Conteiner teclado
teclado = uipanel(MainFrm, ...
  'units', 'normalized', ...
  'position', [0, 0, 0.3, 0.5]);

#Codigo ascii do caractere|indice|cor
teclas = [
  49 1 [0.90980 0.90980 0.90588]
  50 2 [0.90980 0.90980 0.90588]
  51 3 [0.90980 0.90980 0.90588]
  65 12 [242/255 165/255 165/255]
  52 4 [0.90980 0.90980 0.90588]
  53 5 [0.90980 0.90980 0.90588]
  54 6 [0.90980 0.90980 0.90588]
  66 13 [242/255 165/255 165/255]
  55 7 [0.90980 0.90980 0.90588]
  56 8 [0.90980 0.90980 0.90588]
  57 9 [0.90980 0.90980 0.90588]
  67 14 [242/255 165/255 165/255]
  42 10 [153/255 190/255 255/255]
  48 0 [0.90980 0.90980 0.90588]
  35 11 [153/255 190/255 255/255]
  68 15 [242/255 165/255 165/255]
];

for i = 1:1:16,
  d = i/4;
  m = ceil(d)-1;
  uicontrol(teclado, ...
    'style', 'pushbutton', ...
    'backgroundcolor', [teclas(i, 3) teclas(i, 4) teclas(i, 5)], ...
    'string', char(teclas(i, 1)), ...
    'units', 'normalized', ...
    'position', [d-m-0.25, 0.75-(m*0.25), 0.25, 0.25], ...
    'callback', {@aperta, teclas(i, 2), txt_frm, g11, g12, g21, g22});
endfor

set(txt_frm, 'string', 'URASim'); #Indica sistema pronto

% Limpeza
clear teclas t i m d; #Limpa variaveis de construção do teclado
clear MainFrm grafico1 grafico2 texto; # Limpa variaveis de construção iu

#{
uicontrol(teclado, ...
  'style', 'pushbutton', ...
  'string', '1', ...
  'units', 'normalized', ...
  'position', [0, 0.75, 0.25, 0.25], ...
  'callback', {@aperta, 1, txt_frm, g1, g2});

uicontrol(teclado, ...
  'style', 'pushbutton', ...
  'string', '2', ...
  'units', 'normalized', ...
  'position', [0.25, 0.75, 0.25, 0.25], ...
  'callback', {@aperta, 2, txt_frm, g1, g2});

uicontrol(teclado, ...
  'style', 'pushbutton', ...
  'string', '3', ...
  'units', 'normalized', ...
  'position', [0.50, 0.75, 0.25, 0.25], ...
  'callback', {@aperta, 3, txt_frm, g1, g2});

uicontrol(teclado, ...
  'style', 'pushbutton', ...
  'string', '4', ...
  'units', 'normalized', ...
  'position', [0, 0.5, 0.25, 0.25], ...
  'callback', {@aperta, 4, txt_frm, g1, g2});

uicontrol(teclado, ...
  'style', 'pushbutton', ...
  'string', '5', ...
  'units', 'normalized', ...
  'position', [0.25, 0.5, 0.25, 0.25], ...
  'callback', {@aperta, 5, txt_frm, g1, g2});

uicontrol(teclado, ...
  'style', 'pushbutton', ...
  'string', '6', ...
  'units', 'normalized', ...
  'position', [0.5, 0.5, 0.25, 0.25], ...
  'callback', {@aperta, 6, txt_frm, g1, g2});

uicontrol(teclado, ...
  'style', 'pushbutton', ...
  'string', '7', ...
  'units', 'normalized', ...
  'position', [0, 0.25, 0.25, 0.25], ...
  'callback', {@aperta, 7, txt_frm, g1, g2});

uicontrol(teclado, ...
  'style', 'pushbutton', ...
  'string', '8', ...
  'units', 'normalized', ...
  'position', [0.25, 0.25, 0.25, 0.25], ...
  'callback', {@aperta, 8, txt_frm, g1, g2});

uicontrol(teclado, ...
  'style', 'pushbutton', ...
  'string', '9', ...
  'units', 'normalized', ...
  'position', [0.5, 0.25, 0.25, 0.25], ...
  'callback', {@aperta, 9, txt_frm, g1, g2});

uicontrol(teclado, ...
  'style', 'pushbutton', ...
  'string', '0', ...
  'units', 'normalized', ...
  'position', [0.25, 0, 0.25, 0.25], ...
  'backgroundcolor', [1 1 1], ...
  'callback', {@aperta, 0, txt_frm, g1, g2});

uicontrol(teclado, ...
  'style', 'pushbutton', ...
  'string', '*', ...
  'units', 'normalized', ...
  'position', [0, 0, 0.25, 0.25], ...
  'backgroundcolor', [153/255 190/255 255/255], ...
  'callback', {@aperta, 10, txt_frm, g1, g2});

uicontrol(teclado, ...
  'style', 'pushbutton', ...
  'string', '#', ...
  'units', 'normalized', ...
  'position', [0.5, 0, 0.25, 0.25], ...
  'backgroundcolor', [153/255 190/255 255/255], ...
  'callback', {@aperta, 11, txt_frm, g1, g2});

uicontrol(teclado, ...
  'style', 'pushbutton', ...
  'string', 'A', ...
  'units', 'normalized', ...
  'position', [0.75, 0.75, 0.25, 0.25], ...
  'backgroundcolor', [242/255 165/255 165/255], ...
  'callback', {@aperta, 12, txt_frm, g1, g2});

uicontrol(teclado, ...
  'style', 'pushbutton', ...
  'string', 'B', ...
  'units', 'normalized', ...
  'position', [0.75, 0.5, 0.25, 0.25], ...
  'backgroundcolor', [242/255 165/255 165/255], ...
  'callback', {@aperta, 13, txt_frm, g1, g2});

uicontrol(teclado, ...
  'style', 'pushbutton', ...
  'string', 'C', ...
  'units', 'normalized', ...
  'position', [0.75, 0.25, 0.25, 0.25], ...
  'backgroundcolor', [242/255 165/255 165/255], ...
  'callback', {@aperta, 14, txt_frm, g1, g2});

uicontrol(teclado, ...
  'style', 'pushbutton', ...
  'string', 'D', ...
  'units', 'normalized', ...
  'position', [0.75, 0, 0.25, 0.25], ...
  'backgroundcolor', [242/255 165/255 165/255], ...
  'callback', {@aperta, 15, txt_frm, g1, g2});
}#